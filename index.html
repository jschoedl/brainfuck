<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="browser-ie7 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="browser-ie8 lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="browser-ie9 lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="browser-modern"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Brainfuck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="vendor/tachyons/tachyons.min.css">
    <link rel="stylesheet" href="vendor/codemirror/codemirror.css">
    <link rel="stylesheet" href="src/editor.css">

    <meta name="theme-color" content="#ffffff">
    <meta name="og:site_name" content="Marcos Minond">
    <meta name="og:title" content="Marcos Minond">
    <meta name="og:description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="referrer" content="origin">
  </head>
  <body>
    <section id="view"></section>
    <script src="build/main.js"></script>
    <script src="vendor/node-process/browser.js"></script>
    <script src="vendor/codemirror/codemirror.js"></script>
    <script src="vendor/codemirror/brainfuck.js"></script>
    <script src="vendor/requirejs/require.js"></script>
    <script>
    requirejs(['vendor/embeddable-interpreters/brainfuck.js'], function (bf) {
      var app, tick, cont, timer, speed, editor;

      speed = 1;
      app = Elm.Main.embed(document.getElementById('view'));

      app.ports.cmd.subscribe(function (args) {
        var cmd = args[0],
          runtime = args[1];

        switch (cmd) {
        case "speed":
          speed = runtime.speed || 1;
          break;

        case "init":
          if (editor) {
            return;
          }

          if (runtime) {
            speed = runtime.speed || 1;
          }

          editor = CodeMirror.fromTextArea(document.querySelector('textarea'), {
            flattenSpans: false,
            mode: 'brainfuck',
            theme: 'custom',
          });

          editor.on('change', function () {
            tick = null;
            app.ports.unload.send(editor.getValue());
          });

          editor.getWrapperElement().addEventListener('click', function (ev) {
            if (ev.target.matches('.cm-keyword, .cm-bracket, .cm-def, .cm-atom')) {
              var elems = document.querySelectorAll('.cm-keyword, .cm-bracket, .cm-def, .cm-atom');
              var index = [].indexOf.call(elems, ev.target);

              if (index >= 0) {
                app.ports.breakpoint.send(index);

                if (ev.target.classList.contains('breakpoint')) {
                  ev.target.classList.remove('breakpoint');
                } else {
                  ev.target.classList.add('breakpoint');
                }
              }
            }
          });
          break;

        case "load":
          tick = null;

          if (runtime) {
            editor.setValue(runtime.program);
          }

          break;

        case "start":
          if (timer) {
            clearTimeout(timer);
          }

          if (runtime) {
            run(runtime);
            cont = true;
            onTimer();
          }

          break;

        case "step":
          if (tick) {
            cont = false;
            tick();
          } else if (runtime) {
            run(runtime);
          }
          break;

        case "pause":
          cont = false;
          break;

        case "continue":
          cont = true;
          onTimer()
          break;
        }
      })

      function onTimer() {
        if (tick) {
          tick();

          if (cont) {
            timer = setTimeout(onTimer, speed);
          }
        }
      }

      function run(runtime) {
        bf.exec(runtime.program.replace(/[^\+\-\,\.\<\>\[\]]/g, ''), {
          tick: function (_tick, update, state) {
            tick = null;

            var memory = [];
            var breakpoints = [];

            for (var i = 0, len = state.memory.length; i < len; i++) {
              memory[i] = state.memory[i] || 0;
            }

            for (var i = 0, len = runtime.breakpoints.length; i < len; i++) {
              breakpoints[i] = runtime.breakpoints[i] || 0;
            }

            app.ports.tick.send({
              program: runtime.program,
              pointer: state.pointer,
              idx: state.idx,
              steps: state.steps,
              speed: speed,
              memory: memory,
              breakpoints: breakpoints,
            });

            tick = _tick;

            // highlight active optcode
            var last = document.querySelector('.active');
            if (last) {
              last.classList.remove('active');
            }

            var active = document.querySelectorAll('.cm-keyword, .cm-bracket, .cm-def, .cm-atom')[state.idx]
            if (active) {
              active.classList.add('active');
            }
          },

          write: function (str) {
            app.ports.output.send(str);
            console.log(str);
          },

          done: function () {
            console.log('done');
            tick = null;
          },
        });
      }
    });
    </script>
    <footer class="bt pa3 pa4-ns mt1 mt4-ns b--light-gray spectral pv3 pv4-ns">
      <div class="container">
        <p class="lh-copy w-50-ns">
        My name is
        <a href="/" class="link red dim">Marcos Minond</a>,
        and I'm a computer programmer living in Provo, Utah. Checkout my
        <a href="/resume" class="link red dim">resume</a>
        and
        <a target="_blank" href="https://github.com/minond" class="link red dim">GitHub</a>,
        and if you'd like to contact me just
        <a target="_self" href="mailto:minond.marcos+site@gmail.com" class="link red dim">send me an email</a>.
        </p>
      </div>
    </footer>
  </body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-102424562-1', 'auto');
  ga('send', 'pageview');
</script>
</html>
